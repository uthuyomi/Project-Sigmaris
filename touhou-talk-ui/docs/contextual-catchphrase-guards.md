# 脈絡のない“決め台詞”ガード（Contextual Catchphrase Guards）

目的：キャラクター性を保ちつつ、会話の流れに合わない“決め台詞”が突然出て不自然になるのを抑える。

## 方針

- **保守的に**：明らかに不自然になりやすい表現のみ対象にする
- **意味を壊さない**：削除/置換は最小限（会話の主題は維持）
- **文脈で判定**：初回ターンか、直近のユーザー発話にトリガー語がある場合だけ許可

## 実装場所

- `touhou-talk-ui/app/api/session/[sessionId]/message/route.ts`
  - `sanitizeReplyByContext(...)`：返信文の後処理
  - 非ストリーム返信：保存/返却前に適用
  - ストリーム：`done` イベントの `reply` と永続化前に適用

## 現在のガード内容

### 共通

- ユーザー発話の分類説明（例：「『元気？』は挨拶/調子チェック」）を削除（AI臭の抑制）

### こいし（roleplay）

- 「みつけた」：初回ターン or 直近ユーザー発話に「見つけ/探す/かくれんぼ/どこ/いる/気づ」などがある場合のみ許可
  - それ以外は文頭の「みつけた」を「ふふ。」へ置換
- 「やっほー」：初回ターン or 直近ユーザー発話に「やっほ/こんにちは/はじめまして/雑談/話す」などがある場合のみ許可
  - それ以外は文頭の「やっほー」を「ねえねえ。」へ置換

## 拡張

必要に応じて、キャラIDごとに対象フレーズとトリガー語を追加する。

